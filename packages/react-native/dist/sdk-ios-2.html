<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>StorySDK</title>
  <!-- Включаем необходимые библиотеки -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
  
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest" crossorigin></script>
  
  <!-- Подключаем стили StorySDK -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@storysdk/core@latest/dist/bundle.css" />
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: transparent;
    }
    #storysdk-container {
      width: 100%;
      height: 100%;
    }
    #storysdk-debug {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      font-family: monospace;
      font-size: 14px;
      max-height: 50%;
      overflow: auto;
      padding: 10px;
      z-index: 9999;
      display: none;
    }
    #storysdk-debug-toggle {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 14px;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <div id="storysdk-container-render"></div>
  <div id="storysdk-debug"></div>
  <button id="storysdk-debug-toggle">Debug</button>
  
  <script>
    // Функция для вывода отладочной информации
    function debug(message, data) {
      console.log(message, data);
      
      const debugContainer = document.getElementById('storysdk-debug');
      if (debugContainer) {
        const logEntry = document.createElement('div');
        logEntry.style.borderBottom = '1px solid #444';
        logEntry.style.padding = '3px 0';
        
        const timestamp = new Date().toISOString().slice(11, 23);
        
        let content = `<span style="color: #aaa">[${timestamp}]</span> ${message}`;
        
        if (data !== undefined) {
          try {
            if (typeof data === 'object') {
              content += `<pre style="margin: 2px 0; color: #8f8;">${JSON.stringify(data, null, 2)}</pre>`;
            } else {
              content += ` <span style="color: #8f8;">${data}</span>`;
            }
          } catch (e) {
            content += ` <span style="color: #f88;">[Error: ${e.message}]</span>`;
          }
        }
        
        logEntry.innerHTML = content;
        debugContainer.appendChild(logEntry);
        debugContainer.scrollTop = debugContainer.scrollHeight;
      }
    }

    // Получение URL скрипта в зависимости от режима
    function getSDKUrl(mode) {
      const url = mode === 'development' 
        ? 'http://localhost:3003/bundle.umd.js'
        : 'https://cdn.jsdelivr.net/npm/@storysdk/core@latest/dist/bundle.umd.js';
        
      debug('Используем URL для SDK:', url);
      return url;
    }

    // Загрузка скрипта SDK с дополнительной отладкой
    function loadSDKScript(mode) {
      return new Promise((resolve, reject) => {
        // Если скрипт уже загружен, используем существующий
        if (typeof window.Story === 'function') {
          debug('SDK уже загружен, используем существующий (конструктор Story доступен напрямую)');
          resolve(true);
          return;
        }

        const scriptUrl = getSDKUrl(mode);
        debug('Загрузка SDK скрипта из:', scriptUrl);
        
        const script = document.createElement('script');
        
        // Добавляем обработчики до установки src
        script.onerror = (error) => {
          debug('Ошибка загрузки скрипта:', error);
          console.error('Ошибка загрузки скрипта:', error);
          resolve(false);
        };
        
        script.onload = () => {
          debug('Скрипт успешно загружен. Проверяем доступность Story');
          
          // Дополнительная отладочная информация
          if (typeof window.StorySDK !== 'undefined') {
            debug('window.StorySDK доступен:', {
              type: typeof window.StorySDK,
              hasStory: typeof window.StorySDK === 'object' && 'Story' in window.StorySDK,
              storyType: typeof window.StorySDK === 'object' ? typeof window.StorySDK.Story : 'недоступно'
            });
          } else {
            debug('window.StorySDK недоступен');
          }
          
          debug('window.Story:', typeof window.Story);
          
          // После изменений в экспорте, Story должен быть доступен напрямую
          if (typeof window.Story === 'function') {
            debug('Story конструктор доступен напрямую как window.Story - успех!');
            resolve(true);
          } 

     
        };
        
        // Устанавливаем атрибуты
        // script.async = true;
        script.crossOrigin = 'anonymous';
        
        // Устанавливаем src после назначения обработчиков
        script.src = scriptUrl;
        
        // Добавляем в DOM
        document.head.appendChild(script);
        debug('Элемент script добавлен в head');
      });
    }

    // Настройка отладочной панели
    document.addEventListener('DOMContentLoaded', function() {
      const debugToggle = document.getElementById('storysdk-debug-toggle');
      const debugContainer = document.getElementById('storysdk-debug');
      
      // Сразу показываем отладочную панель
      debugContainer.style.display = 'block';
      debugToggle.innerText = 'Hide Debug';
      
      debugToggle.addEventListener('click', function() {
        if (debugContainer.style.display === 'none' || !debugContainer.style.display) {
          debugContainer.style.display = 'block';
          debugToggle.innerText = 'Hide Debug';
        } else {
          debugContainer.style.display = 'none';
          debugToggle.innerText = 'Debug';
        }
      });
      
      let storySDK = null;
      let externalSDKLoaded = false;

      // Инициализация SDK
      function initSDK(options) {
        // Уничтожаем предыдущий экземпляр, если он существует
        if (storySDK) {
          storySDK.destroy();
        }
        
        try {
          debug('Инициализация SDK с опциями:', options);
          
          // Пробуем загрузить скрипт в зависимости от devMode
          loadSDKScript(options.devMode)
            .then((loaded) => {
              externalSDKLoaded = loaded;
              debug('Статус загрузки внешнего SDK:', externalSDKLoaded);
              debug('Тип window.Story:', typeof window.Story);

              if (externalSDKLoaded) {
                // Внешний SDK загружен успешно
                debug('Используем загруженный SDK');
                try {
                  // После наших изменений, Story должен быть доступен напрямую
                  storySDK = new window.Story(options.token, options);
                  debug('SDK успешно инициализирован');
                } catch (error) {
                  debug('Ошибка при создании экземпляра Story:', error);
                  // Используем запасной вариант
                  debug('Используем запасной вариант');
                  storySDK = new window.FallbackStory(options.token, options);
                }
              } 
              
              // Если включен режим отладки, показываем отладочную панель
              if (options.isDebugMode) {
                debugContainer.style.display = 'block';
                debugToggle.innerText = 'Hide Debug';
              }
              
              // Получаем контейнер для рендеринга
              const container = document.querySelector('#storysdk-container-render');

              if (!container) {
                throw new Error('Контейнер не найден');
              }

      
              debug('container details', {
                tagName: container.tagName,
                id: container.id,
                className: container.className,
                children: container.children.length
              });
              debug('storySDK before renderGroups', {
                hasMethod: typeof storySDK.renderGroups === 'function',
                storySDKProps: Object.keys(storySDK)
              });
              // Рендерим группы
              try {
                storySDK.renderGroups(container);
              } catch (error) {
                debug('Ошибка при вызове renderGroups:', error);
                console.error('Детали ошибки:', error.stack);
              }
              
              // Задаем глобальную переменную SDK
              window.storysdk = storySDK;
              
              // Пересылаем все события SDK в React Native
              forwardEvents(storySDK);
              
              // Оповещаем об успешной инициализации
              postMessageToReactNative('init:success', { 
                message: 'StorySDK initialized successfully', 
                usingExternalSDK: externalSDKLoaded 
              });
            })
            .catch(error => {
              debug('Ошибка при загрузке/инициализации SDK:', error);
              // // В случае ошибки используем запасной вариант
              // debug('Используем запасной вариант из-за ошибки');
              // storySDK = new window.FallbackStory(options.token, options);
              
              // // Получаем контейнер для рендеринга
              // const container = document.getElementById('storysdk-container');
              // if (container) {
              //   // Рендерим группы
              //   storySDK.renderGroups(container);
                
              //   // Задаем глобальную переменную SDK
              //   window.storysdk = storySDK;
                
              //   // Пересылаем все события SDK в React Native
              //   forwardEvents(storySDK);
                
              //   // Оповещаем об успешной инициализации
              //   postMessageToReactNative('init:success', { 
              //     message: 'StorySDK initialized with fallback', 
              //     usingExternalSDK: false
              //   });
              // } else {
              //   postMessageToReactNative('error', { 
              //     message: 'Failed to initialize StorySDK',
              //     details: 'Container not found'
              //   });
              // }
            });
        } catch (error) {
          debug('Ошибка инициализации StorySDK:', error);
          postMessageToReactNative('error', { 
            message: 'Failed to initialize StorySDK',
            details: error.message 
          });
        }
      }
      
      // Слушаем сообщения от React Native
      window.addEventListener('message', function(event) {
        try {
          const message = JSON.parse(event.data);
          debug('Получено сообщение', message);
          
          if (message.type === 'init') {
            const options = JSON.parse(message.options);
            console.log('options', options);

            // const container = document.getElementById('storysdk-container');
            // if (!container) {
            //   throw new Error('Контейнер не найден');
            // }

            // initSDK(options, container);


            initSDK(options);
          }
        } catch (error) {
          debug('Ошибка обработки сообщения:', error);
          postMessageToReactNative('error', { 
            message: 'Error processing message',
            details: error.message
          });
        }
      });
      
      // Функция для отправки сообщений в React Native
      function postMessageToReactNative(type, data) {
        if (window.ReactNativeWebView) {
          const message = {
            type,
            data: data || {}
          };
          
          try {
            window.ReactNativeWebView.postMessage(JSON.stringify(message));
          } catch (error) {
            console.error('Ошибка отправки сообщения в React Native:', error);
          }
        }
      }
      
      // Пересылка событий SDK в React Native
      function forwardEvents(sdk) {
        const events = [
          'storysdk:widget:click',
          'storysdk:widget:answer',
          'storysdk:group:open',
          'storysdk:group:close',
          'storysdk:story:open',
          'storysdk:story:close',
          'storysdk:story:next',
          'storysdk:story:prev',
          'storysdk:modal:open',
          'storysdk:modal:close',
          'storysdk:group:click'
        ];
        
        events.forEach(eventName => {
          sdk.on(eventName, (data) => {
            postMessageToReactNative(eventName, data);
          });
        });
      }
      
      // Оповещаем React Native о готовности WebView
      postMessageToReactNative('webview:ready', {});
    });
  </script>
</body>
</html> 